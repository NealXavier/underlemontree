{% style %}
.slider-wrapper {
    display: flex;
    justify-content: center;
    /* 移除固定高度，由 JS 动态设置 */
}

.slide {
    width: 200px;
    position: relative;
    overflow: hidden;
    height: 100%;
    transition: width 0.3s ease;
    cursor: pointer;
}

.slide img {
    position: absolute;
    height: 100%;
    width: 600px;
    left: -200px;
    object-fit: cover;
    transition: left 0.3s ease;
}

.slide:hover {
    width: 600px;
}

.slide:hover img {
    left: 0;
}

@media screen and (max-width: 768px) {
    .slide {
        width: 150px;
    }
    
    .slide img {
        width: 450px;
        left: -150px;
    }
    
    .slide:hover {
        width: 450px;
    }
}
{% endstyle %}

<div class="slider-wrapper">
  {% for block in section.blocks %}
    <div class="slide" 
      {{ block.shopify_attributes }}
      {% if block.settings.link != blank %}
        data-href="{{ block.settings.link }}"
      {% endif %}
    >
      {% if block.settings.image != blank %}
        <img 
          src="{{ block.settings.image | img_url: '1200x' }}" 
          alt="{{ block.settings.title }}"
          loading="{% if forloop.first %}eager{% else %}lazy{% endif %}"
          onload="if(this.complete) calculateWrapperHeight(this)"
        >
      {% endif %}
    </div>
  {% endfor %}
</div>

<script>
  // 存储所有图片高度
  let imageHeights = [];
  
  // 计算并设置 wrapper 高度
  function calculateWrapperHeight(img) {
    // 创建一个临时图片来获取实际尺寸
    const tempImg = new Image();
    tempImg.src = img.src;
    
    tempImg.onload = function() {
      // 计算等比例缩放后的高度
      const aspectRatio = this.width / this.height;
      const scaledHeight = 600 / aspectRatio; // 600px 是设置的图片宽度
      
      imageHeights.push(scaledHeight);
      
      // 如果所有图片都加载完成，设置 wrapper 高度
      const wrapper = document.querySelector('.slider-wrapper');
      if (imageHeights.length === wrapper.querySelectorAll('img').length) {
        // 使用最小高度作为 wrapper 高度
        const minHeight = Math.min(...imageHeights);
        wrapper.style.height = `${minHeight}px`;
        
        // 更新所有 slide 的高度
        wrapper.querySelectorAll('.slide').forEach(slide => {
          slide.style.height = `${minHeight}px`;
        });
      }
    };
  }
  
  // 监听窗口大小变化，重新计算高度
  window.addEventListener('resize', () => {
    imageHeights = [];
    document.querySelectorAll('.slider-wrapper img').forEach(img => {
      calculateWrapperHeight(img);
    });
  });

  // 为所有 slide 添加点击事件
  document.querySelectorAll('.slide').forEach(slide => {
    slide.addEventListener('click', function() {
      const url = this.dataset.href;
      if (url) {
        // 可以选择在新窗口打开或当前窗口打开
        window.location.href = url; // 当前窗口打开
        // window.open(url, '_blank'); // 新窗口打开
      }
    });
  });
</script>

{% schema %}
{
  "name": "图片展示",
  "settings": [
    {
      "type": "range",
      "id": "items_per_row",
      "min": 2,
      "max": 6,
      "step": 1,
      "default": 4,
      "label": "每行显示数量"
    }
  ],
  "blocks": [
    {
      "type": "slide",
      "name": "图片",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "图片"
        },
        {
          "type": "text",
          "id": "title",
          "label": "标题"
        },
        {
          "type": "text",
          "id": "button_text",
          "label": "按钮文字"
        },
        {
          "type": "url",
          "id": "link",
          "label": "按钮链接"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "图片展示",
      "blocks": [
        {
          "type": "slide"
        },
        {
          "type": "slide"
        },
        {
          "type": "slide"
        },
        {
          "type": "slide"
        }
      ]
    }
  ]
}
{% endschema %}